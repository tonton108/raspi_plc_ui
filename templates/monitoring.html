{% extends "base.html" %}
{% block title %}ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°{% endblock %}

{% block content %}
<div class="monitor-card">
  <h2>ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</h2>
  
  <div class="info-grid">
    <div class="info-item">
      <strong>è¨­å‚™ID:</strong> <span id="equipment-id">{{ equipment.equipment_id or 'N/A' }}</span>
      <span id="data-source-badge" class="source-badge" style="display: none;"></span>
    </div>
    <div class="info-item">
      <strong>PLCãƒ¡ãƒ¼ã‚«ãƒ¼:</strong> <span id="plc-manufacturer">{{ equipment.manufacturer or 'N/A' }}</span>
    </div>
    <div class="info-item">
      <strong>PLCæ¥ç¶šå…ˆ:</strong> <span id="plc-connection">{{ equipment.plc_ip or 'N/A' }}:{{ equipment.plc_port or 'N/A' }}</span>
    </div>
    <div class="info-item">
      <strong>ä¸­å¤®ã‚µãƒ¼ãƒãƒ¼:</strong> <span id="central-server">{{ equipment.central_server_ip or 'N/A' }}:{{ equipment.central_server_port or 'N/A' }}</span>
    </div>
  </div>

  <div class="status-grid">
    <div class="status-item">
      <strong>ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ :</strong> 
      <span id="cycle-time">N/A</span>
    </div>
    <div class="status-item">
      <strong>çŠ¶æ…‹:</strong> 
      <span id="equipment-status" class="status-badge gray">æœªæ¥ç¶š</span>
    </div>
  </div>

  <div class="data-grid" id="plc-data">
    <!-- PLCãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
  </div>

  <div class="button-group">
    <button onclick="testConnection()" class="btn primary">ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <button onclick="openConfigModal()" class="btn secondary">âš™ï¸ è¨­å®šå¤‰æ›´</button>
  </div>
</div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="config-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”§ è¨­å®šå¤‰æ›´</h2>
      <button class="modal-close" onclick="closeConfigModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="config-form" class="form-grid">
        <!-- åŸºæœ¬è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h3 style="color: var(--primary); margin-bottom: 16px;">ğŸ­ åŸºæœ¬è¨­å®š</h3>
          
          <div class="basic-config-grid">
            <div class="form-group">
              <label><strong>è¨­å‚™ID:</strong></label>
              <input type="text" name="equipment_id" id="equipment_id" value="{{ equipment.equipment_id or '' }}" required>
            </div>

            <div class="form-group">
              <label><strong>PLCãƒ¡ãƒ¼ã‚«ãƒ¼:</strong></label>
              <select name="manufacturer" id="manufacturer" required>
                {% for m in manufacturers %}
                  <option value="{{ m }}" {% if equipment.manufacturer == m %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label><strong>ã‚·ãƒªãƒ¼ã‚º:</strong></label>
              <select name="series" id="series" required>
                {% for s in series_list.get(equipment.manufacturer or '', []) %}
                  <option value="{{ s }}" {% if equipment.series == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label><strong>ğŸ¯ PLC IPã‚¢ãƒ‰ãƒ¬ã‚¹:</strong></label>
              <input type="text" name="plc_ip" id="plc_ip" value="{{ equipment.plc_ip or '192.168.1.100' }}" 
                     placeholder="ä¾‹: 192.168.1.100" required>
            </div>

            <div class="form-group">
              <label><strong>PLCãƒãƒ¼ãƒˆ:</strong></label>
              <input type="number" name="plc_port" id="plc_port" value="{{ equipment.plc_port or 5000 }}" required>
            </div>

            <div class="form-group">
              <label><strong>ğŸŒ ä¸­å¤®ã‚µãƒ¼ãƒãƒ¼IP:</strong></label>
              <input type="text" name="central_server_ip" id="central_server_ip" value="{{ equipment.central_server_ip or '192.168.1.10' }}" 
                     placeholder="ä¾‹: 192.168.1.10" required>
            </div>

            <div class="form-group">
              <label><strong>ä¸­å¤®ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆ:</strong></label>
              <input type="number" name="central_server_port" id="central_server_port" value="{{ equipment.central_server_port or 5000 }}" required>
            </div>

            <div class="form-group">
              <label><strong>å–å¾—é–“éš” (ms):</strong></label>
              <input type="number" name="interval" id="interval" value="{{ equipment.interval or 1000 }}" required>
            </div>

            <div class="form-group">
              <label><strong>ğŸ”Œ Modbusãƒãƒ¼ãƒˆ:</strong> <small style="color: #666;">â€»ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹PLCä½¿ç”¨æ™‚ã®ã¿å¿…è¦</small></label>
              <input type="number" name="modbus_port" id="modbus_port" value="{{ equipment.modbus_port or 502 }}" 
                     placeholder="ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹ç”¨ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 502)">
            </div>
          </div>
        </div>

        <!-- PLCã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h3 style="color: var(--primary); margin: 20px 0 16px 0;">ğŸ“ PLCãƒ‡ãƒ¼ã‚¿é …ç›®è¨­å®š</h3>
          
          <div class="data-config-section">
            <div class="plc-config-grid">
              
              <!-- ç”Ÿç”£æ•°é‡ -->
              <div class="plc-config-item">
                <label class="plc-config-toggle">
                  <input type="checkbox" name="production_count_enabled" value="true" 
                         {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.enabled %}checked{% endif %}>
                  <span class="plc-icon">ğŸ“Š</span>
                  <strong>ç”Ÿç”£æ•°é‡</strong>
                </label>
                <div class="plc-config-inputs">
                  <input type="text" name="production_count_address" 
                         value="{{ equipment.data_points.production_count.address if equipment.data_points and equipment.data_points.production_count else 'D150' }}" 
                         placeholder="D150">
                  <select name="production_count_data_type" class="data-type-select">
                    <option value="word" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'word' %}selected{% elif not equipment.data_points or not equipment.data_points.production_count %}selected{% endif %}>Word (16bit)</option>
                    <option value="dword" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                    <option value="float32" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'float32' %}selected{% endif %}>Float32</option>
                    <option value="bit" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'bit' %}selected{% endif %}>Bit</option>
                  </select>
                  <input type="number" name="production_count_scale" 
                         value="{{ equipment.data_points.production_count.scale if equipment.data_points and equipment.data_points.production_count else 1 }}" 
                         placeholder="å€ç‡" min="1">
                </div>
              </div>

              <!-- é›»æµ -->
              <div class="plc-config-item">
                <label class="plc-config-toggle">
                  <input type="checkbox" name="current_enabled" value="true" 
                         {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.enabled %}checked{% else %}checked{% endif %}>
                  <span class="plc-icon">âš¡</span>
                  <strong>é›»æµ</strong>
                </label>
                <div class="plc-config-inputs">
                  <input type="text" name="current_address" 
                         value="{{ equipment.data_points.current.address if equipment.data_points and equipment.data_points.current else 'D100' }}" 
                         placeholder="D100">
                  <select name="current_data_type" class="data-type-select">
                    <option value="word" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'word' %}selected{% endif %}>Word (16bit)</option>
                    <option value="dword" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                    <option value="float32" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'float32' %}selected{% endif %}>Float32</option>
                    <option value="bit" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'bit' %}selected{% endif %}>Bit</option>
                  </select>
                  <input type="number" name="current_scale" 
                         value="{{ equipment.data_points.current.scale if equipment.data_points and equipment.data_points.current else 10 }}" 
                         placeholder="å€ç‡" min="1">
                </div>
              </div>

              <!-- æ¸©åº¦ -->
              <div class="plc-config-item">
                <label class="plc-config-toggle">
                  <input type="checkbox" name="temperature_enabled" value="true" 
                         {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.enabled %}checked{% else %}checked{% endif %}>
                  <span class="plc-icon">ğŸŒ¡ï¸</span>
                  <strong>æ¸©åº¦</strong>
                </label>
                <div class="plc-config-inputs">
                  <input type="text" name="temperature_address" 
                         value="{{ equipment.data_points.temperature.address if equipment.data_points and equipment.data_points.temperature else 'D101' }}" 
                         placeholder="D101">
                  <select name="temperature_data_type" class="data-type-select">
                    <option value="word" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'word' %}selected{% endif %}>Word (16bit)</option>
                    <option value="dword" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                    <option value="float32" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'float32' %}selected{% elif not equipment.data_points or not equipment.data_points.temperature %}selected{% endif %}>Float32</option>
                    <option value="bit" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'bit' %}selected{% endif %}>Bit</option>
                  </select>
                  <input type="number" name="temperature_scale" 
                         value="{{ equipment.data_points.temperature.scale if equipment.data_points and equipment.data_points.temperature else 1 }}" 
                         placeholder="å€ç‡" min="1">
                </div>
              </div>

              <!-- åœ§åŠ› -->
              <div class="plc-config-item">
                <label class="plc-config-toggle">
                  <input type="checkbox" name="pressure_enabled" value="true" 
                         {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.enabled %}checked{% else %}checked{% endif %}>
                  <span class="plc-icon">ğŸ”§</span>
                  <strong>åœ§åŠ›</strong>
                </label>
                <div class="plc-config-inputs">
                  <input type="text" name="pressure_address" 
                         value="{{ equipment.data_points.pressure.address if equipment.data_points and equipment.data_points.pressure else 'D102' }}" 
                         placeholder="D102">
                  <select name="pressure_data_type" class="data-type-select">
                    <option value="word" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'word' %}selected{% elif not equipment.data_points or not equipment.data_points.pressure %}selected{% endif %}>Word (16bit)</option>
                    <option value="dword" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                    <option value="float32" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'float32' %}selected{% endif %}>Float32</option>
                    <option value="bit" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'bit' %}selected{% endif %}>Bit</option>
                  </select>
                  <input type="number" name="pressure_scale" 
                         value="{{ equipment.data_points.pressure.scale if equipment.data_points and equipment.data_points.pressure else 100 }}" 
                         placeholder="å€ç‡" min="1">
                </div>
              </div>

              <!-- ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ  -->
              <div class="plc-config-item">
                <label class="plc-config-toggle">
                  <input type="checkbox" name="cycle_time_enabled" value="true" 
                         {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.enabled %}checked{% endif %}>
                  <span class="plc-icon">â±ï¸</span>
                  <strong>ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ </strong>
                </label>
                <div class="plc-config-inputs">
                  <input type="text" name="cycle_time_address" 
                         value="{{ equipment.data_points.cycle_time.address if equipment.data_points and equipment.data_points.cycle_time else 'D200' }}" 
                         placeholder="D200">
                  <select name="cycle_time_data_type" class="data-type-select">
                    <option value="word" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'word' %}selected{% endif %}>Word (16bit)</option>
                    <option value="dword" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'dword' %}selected{% elif not equipment.data_points or not equipment.data_points.cycle_time %}selected{% endif %}>DWord (32bit)</option>
                    <option value="float32" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'float32' %}selected{% endif %}>Float32</option>
                    <option value="bit" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'bit' %}selected{% endif %}>Bit</option>
                  </select>
                  <input type="number" name="cycle_time_scale" 
                         value="{{ equipment.data_points.cycle_time.scale if equipment.data_points and equipment.data_points.cycle_time else 1 }}" 
                         placeholder="å€ç‡" min="1">
                </div>
              </div>

              <!-- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ -->
              <div class="plc-config-item">
                <label class="plc-config-toggle">
                  <input type="checkbox" name="error_code_enabled" value="true" 
                         {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.enabled %}checked{% endif %}>
                  <span class="plc-icon">ğŸš¨</span>
                  <strong>ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰</strong>
                </label>
                <div class="plc-config-inputs">
                  <input type="text" name="error_code_address" 
                         value="{{ equipment.data_points.error_code.address if equipment.data_points and equipment.data_points.error_code else 'D300' }}" 
                         placeholder="D300">
                  <select name="error_code_data_type" class="data-type-select">
                    <option value="word" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'word' %}selected{% elif not equipment.data_points or not equipment.data_points.error_code %}selected{% endif %}>Word (16bit)</option>
                    <option value="dword" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                    <option value="float32" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'float32' %}selected{% endif %}>Float32</option>
                    <option value="bit" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'bit' %}selected{% endif %}>Bit</option>
                  </select>
                  <input type="number" name="error_code_scale" 
                         value="{{ equipment.data_points.error_code.scale if equipment.data_points and equipment.data_points.error_code else 1 }}" 
                         placeholder="å€ç‡" min="1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button type="submit" class="btn primary">ğŸ’¾ ä¿å­˜</button>
          <button type="button" onclick="closeConfigModal()" class="btn secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="passwordModal" class="password-modal" style="display: none;">
  <div class="password-modal-overlay"></div>
  <div class="password-modal-content">
    <div class="password-modal-header">
      <div class="security-icon">ğŸ”’</div>
      <h3>è¨­å®šå¤‰æ›´ã®ç¢ºèª</h3>
      <p>è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    </div>
    
    <form id="passwordForm">
      <div class="form-group">
        <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
        <input type="password" id="confirmPassword" name="password" required autofocus>
      </div>
      
      <div id="passwordError" class="error-message" style="display: none;"></div>
      
      <div class="modal-buttons">
        <button type="submit" class="btn primary">ç¢ºèª</button>
        <button type="button" id="cancelPassword" class="btn secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>
</div>

<style>
/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.password-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 2000; /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
}

.password-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
}

.password-modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  width: 400px;
  max-width: 90vw;
}

.password-modal-header {
  text-align: center;
  margin-bottom: 25px;
}

.password-modal-header .security-icon {
  font-size: 32px;
  margin-bottom: 10px;
}

.password-modal-header h3 {
  color: var(--primary);
  margin-bottom: 8px;
  font-size: 20px;
}

.password-modal-header p {
  color: #666;
  font-size: 14px;
}

.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.modal-buttons .btn {
  flex: 1;
}

.error-message {
  background: #ffe6e6;
  color: #d32f2f;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 15px;
  border-left: 4px solid #d32f2f;
  font-size: 14px;
}

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
body.dark .password-modal-content {
  background: var(--card);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}

body.dark .password-modal-header h3 {
  color: var(--primary);
}

body.dark .password-modal-header p {
  color: #ccc;
}

body.dark .error-message {
  background: rgba(244, 67, 54, 0.2);
  color: #ef5350;
  border-left: 4px solid #ef5350;
}
</style>

<style>
.source-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: 8px;
  font-weight: bold;
}

.source-badge.database {
  background: #4caf50;
  color: white;
}

.source-badge.local {
  background: #ff9800;
  color: white;
}
</style>

<script>
  let lastTimestamp = null;
  let currentEquipmentInfo = null;

  // è¨­å‚™æƒ…å ±ã‚’DBå„ªå…ˆã§å–å¾—ãƒ»æ›´æ–°
  async function updateEquipmentInfo() {
    try {
      const response = await fetch('/api/current-equipment-info');
      if (!response.ok) {
        throw new Error('è¨­å‚™æƒ…å ±å–å¾—å¤±æ•—');
      }
      
      const equipmentInfo = await response.json();
      currentEquipmentInfo = equipmentInfo;
      
      console.log('ğŸ“Š [DEBUG] è¨­å‚™æƒ…å ±æ›´æ–°:', equipmentInfo);
      
      // è¨­å‚™æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('equipment-id').textContent = equipmentInfo.equipment_id || 'N/A';
      document.getElementById('plc-manufacturer').textContent = equipmentInfo.manufacturer || 'N/A';
      document.getElementById('plc-connection').textContent = 
        `${equipmentInfo.plc_ip || 'N/A'}:${equipmentInfo.plc_port || 'N/A'}`;
      document.getElementById('central-server').textContent = 
        `${equipmentInfo.central_server_ip || 'N/A'}:${equipmentInfo.central_server_port || 'N/A'}`;
      
      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚¸ã‚’æ›´æ–°
      const sourceBadge = document.getElementById('data-source-badge');
      if (equipmentInfo.source === 'database') {
        sourceBadge.textContent = 'DBå„ªå…ˆ';
        sourceBadge.className = 'source-badge database';
        sourceBadge.style.display = 'inline';
      } else if (equipmentInfo.source === 'local_config') {
        sourceBadge.textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®š';
        sourceBadge.className = 'source-badge local';
        sourceBadge.style.display = 'inline';
      } else {
        sourceBadge.style.display = 'none';
      }
      
      // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸå€¤ã‚‚æ›´æ–°
      updateConfigModalValues(equipmentInfo);
      
    } catch (error) {
      console.error('âŒ è¨­å‚™æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸå€¤ã‚’æ›´æ–°
  function updateConfigModalValues(equipmentInfo) {
    if (!equipmentInfo) return;
    
    // åŸºæœ¬è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    const fieldMappings = {
      'equipment_id': equipmentInfo.equipment_id,
      'manufacturer': equipmentInfo.manufacturer,
      'series': equipmentInfo.series,
      'plc_ip': equipmentInfo.plc_ip,
      'plc_port': equipmentInfo.plc_port,
      'modbus_port': equipmentInfo.modbus_port,
      'central_server_ip': equipmentInfo.central_server_ip,
      'central_server_port': equipmentInfo.central_server_port,
      'interval': equipmentInfo.interval
    };
    
    Object.entries(fieldMappings).forEach(([fieldId, value]) => {
      const element = document.getElementById(fieldId);
      if (element && value !== undefined && value !== null) {
        element.value = value;
      }
    });
  }

  function updateMonitoringData() {
    fetch('/api/logs')
      .then(res => {
        if (!res.ok) {
          throw new Error("ãƒ­ã‚°å–å¾—å¤±æ•—");
        }
        return res.json();
      })
      .then(response => {
        const now = new Date();
        const cycleTime = lastTimestamp ? now - lastTimestamp : null;
        lastTimestamp = now;

        // ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        if (cycleTime !== null) {
          document.getElementById("cycle-time").textContent = `${cycleTime} ms`;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        const statusEl = document.getElementById("equipment-status");
        if (cycleTime > 5000) {
          statusEl.textContent = "åœæ­¢";
          statusEl.className = "status-badge red";
        } else {
          statusEl.textContent = "ç¨¼åƒä¸­";
          statusEl.className = "status-badge green";
        }

        // PLCãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        if (response.data) {
          updatePLCData(response.data);
        }
      })
      .catch(err => {
        console.error("ãƒ­ã‚°å–å¾—å¤±æ•—", err);
        document.getElementById("cycle-time").textContent = "N/A";
        const statusEl = document.getElementById("equipment-status");
        statusEl.textContent = "æœªæ¥ç¶š";
        statusEl.className = "status-badge gray";
      });
  }

  function updatePLCData(data) {
    const dataGrid = document.getElementById("plc-data");
    dataGrid.innerHTML = "";
    
    Object.entries(data).forEach(([key, value]) => {
      const item = document.createElement("div");
      item.className = "data-item";
      
      const label = getDataLabel(key);
      const unit = getDataUnit(key);
      
      item.innerHTML = `
        <strong>${label}:</strong> 
        <span class="data-value">${value}${unit}</span>
      `;
      dataGrid.appendChild(item);
    });
  }

  function getDataLabel(key) {
    const labels = {
      'current': 'é›»æµ',
      'temperature': 'æ¸©åº¦',
      'pressure': 'åœ§åŠ›',
      'production_count': 'ç”Ÿç”£æ•°é‡',
      'cycle_time': 'ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ ',
      'error_code': 'ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰'
    };
    return labels[key] || key;
  }

  function getDataUnit(key) {
    const units = {
      'current': 'A',
      'temperature': 'â„ƒ',
      'pressure': 'MPa',
      'production_count': 'å€‹',
      'cycle_time': 'ms',
      'error_code': ''
    };
    return units[key] || '';
  }

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => {
      toast.classList.remove("show");
    }, 3000);
  }

  async function testConnection() {
    showToast("æ¥ç¶šä¸­â€¦");

    try {
      const response = await fetch("/test-connection", { method: "POST" });
      const result = await response.json();

      if (result.success) {
        showToast("âœ… æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸ");
      } else {
        showToast("âŒ æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
      }

      setTimeout(() => location.reload(), 1500);

    } catch (error) {
      showToast("âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
  function openConfigModal() {
    // ã¾ãšãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    showPasswordModal();
  }

  function closeConfigModal() {
    document.getElementById('config-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  function showPasswordModal() {
    const passwordModal = document.getElementById('passwordModal');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordError = document.getElementById('passwordError');
    
    passwordModal.style.display = 'block';
    confirmPasswordInput.value = '';
    confirmPasswordInput.type = 'text'; // åˆæœŸçŠ¶æ…‹ã¯textã‚¿ã‚¤ãƒ—
    passwordError.style.display = 'none';
    document.body.style.overflow = 'hidden';
    setTimeout(() => confirmPasswordInput.focus(), 100);
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
  function hidePasswordModal() {
    const passwordModal = document.getElementById('passwordModal');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordError = document.getElementById('passwordError');
    
    passwordModal.style.display = 'none';
    confirmPasswordInput.value = '';
    confirmPasswordInput.type = 'text'; // textã‚¿ã‚¤ãƒ—ã«æˆ»ã™
    passwordError.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å®Ÿéš›ã«é–‹ãï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªå¾Œï¼‰
  function actuallyOpenConfigModal() {
    hidePasswordModal();
    document.getElementById('config-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  function showPasswordError(message) {
    const passwordError = document.getElementById('passwordError');
    passwordError.textContent = message;
    passwordError.style.display = 'block';
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‹•çš„åˆ¶å¾¡
  document.getElementById('confirmPassword').addEventListener('focus', function() {
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¤‰æ›´
    this.type = 'password';
  });

  document.getElementById('confirmPassword').addEventListener('blur', function() {
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤±ã£ãŸæ™‚ã€å€¤ãŒç©ºãªã‚‰textã‚¿ã‚¤ãƒ—ã«æˆ»ã™
    if (!this.value) {
      this.type = 'text';
    }
  });

  document.getElementById('confirmPassword').addEventListener('input', function() {
    // å…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã‚’ç¶­æŒ
    this.type = 'password';
  });

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
  document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password = document.getElementById('confirmPassword').value;
    if (!password) {
      showPasswordError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    try {
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªAPIå‘¼ã³å‡ºã—
      const response = await fetch('/api/verify-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ password: password })
      });

      const result = await response.json();

      if (result.success) {
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„å ´åˆã€è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        actuallyOpenConfigModal();
      } else {
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
        showPasswordError(result.error || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        document.getElementById('confirmPassword').select();
      }
    } catch (error) {
      console.error('Password verification error:', error);
      showPasswordError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  });

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‡¦ç†
  document.getElementById('cancelPassword').addEventListener('click', hidePasswordModal);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  window.onclick = function(event) {
    const configModal = document.getElementById('config-modal');
    const passwordModal = document.getElementById('passwordModal');
    
    if (event.target === configModal) {
      closeConfigModal();
    } else if (event.target === passwordModal || event.target.classList.contains('password-modal-overlay')) {
      hidePasswordModal();
    }
  }

  // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const passwordModal = document.getElementById('passwordModal');
      const configModal = document.getElementById('config-modal');
      
      if (passwordModal.style.display === 'block') {
        hidePasswordModal();
      } else if (configModal.style.display === 'block') {
        closeConfigModal();
      }
    }
  });

  // è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
  document.getElementById('config-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const equipmentId = formData.get('equipment_id');
    
    // FormDataã‚’JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    const configData = {};
    
    // åŸºæœ¬è¨­å®š
    configData.equipment_id = formData.get('equipment_id');
    configData.manufacturer = formData.get('manufacturer');
    configData.series = formData.get('series');
    configData.plc_ip = formData.get('plc_ip');
    configData.plc_port = parseInt(formData.get('plc_port'));
    configData.modbus_port = parseInt(formData.get('modbus_port') || 502);
    configData.interval = parseInt(formData.get('interval'));
    
    // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ï¼ˆç¾åœ¨ã®å€¤ã‚’ä¿æŒï¼‰
    // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã—ãŸå€¤ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
    configData.raspi_ip = "{{ equipment.ip or '192.168.0.100' }}";
    configData.mac_address = "{{ equipment.mac_address or 'a7:cb:75:e8:1e:fb' }}";
    configData.cpu_serial_number = "{{ equipment.cpu_serial_number or 'FALLBACK_FIXED_ID' }}";
    configData.hostname = "{{ equipment.hostname or 'DESKTOP-K88UM9J' }}";
    
    console.log('ğŸ”§ [DEBUG] é€ä¿¡ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±:', {
      mac_address: configData.mac_address,
      cpu_serial_number: configData.cpu_serial_number,
      hostname: configData.hostname,
      raspi_ip: configData.raspi_ip
    });
    
    try {
      // 1. è¨­å‚™åŸºæœ¬è¨­å®šã‚’ä¿å­˜ï¼ˆã“ã‚Œã§ã€Œè¨­å®šæ¸ˆã¿ã€ã«ãªã‚‹ï¼‰
      const configResponse = await fetch(`/api/equipment/${equipmentId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(configData)
      });
      
      if (!configResponse.ok) {
        throw new Error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      // 2. PLCãƒ‡ãƒ¼ã‚¿è¨­å®šã‚’ä¿å­˜
      const plcConfigs = [];
      const dataItems = ['production_count', 'current', 'temperature', 'pressure', 'cycle_time', 'error_code'];
      
      dataItems.forEach(item => {
        const enabled = formData.has(`${item}_enabled`);
        const address = formData.get(`${item}_address`);
        const dataType = formData.get(`${item}_data_type`);
        const scale = parseInt(formData.get(`${item}_scale`) || 1);
        
        if (address) {  // ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¿½åŠ 
          plcConfigs.push({
            data_type: item,
            enabled: enabled,
            address: address,
            scale_factor: scale,
            plc_data_type: dataType
          });
        }
      });
      
      const plcResponse = await fetch(`/api/equipment/${equipmentId}/plc_configs`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(plcConfigs)
      });
      
      if (!plcResponse.ok) {
        throw new Error('PLCãƒ‡ãƒ¼ã‚¿è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      showToast("âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      
      // ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å‚™IDã‚‚æ›´æ–°
      try {
        await fetch('/api/update-local-equipment-id', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ equipment_id: equipmentId })
        });
        console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«è¨­å‚™IDæ›´æ–°å®Œäº†');
      } catch (error) {
        console.warn('âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«è¨­å‚™IDæ›´æ–°ã«å¤±æ•—:', error);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼ˆé‡è¦ã§ã¯ãªã„ï¼‰
      }
      
      closeConfigModal();
      
      // è¨­å®šãŒæ›´æ–°ã•ã‚ŒãŸã®ã§è¨­å‚™æƒ…å ±ã‚’å†å–å¾—ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
      setTimeout(async () => {
        await updateEquipmentInfo();
        showToast("ğŸ“Š è¨­å‚™æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
      }, 500);
      
    } catch (error) {
      console.error('Config save error:', error);
      showToast(`âŒ ${error.message}`);
    }
  });

  // Modbusãƒãƒ¼ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
  function updateModbusPortState() {
    const manufacturer = document.getElementById("manufacturer").value;
    const modbusPortInput = document.getElementById("modbus_port");
    const modbusPortGroup = modbusPortInput.closest('.form-group');
    
    if (manufacturer === "ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹") {
      modbusPortInput.disabled = false;
      modbusPortInput.required = true;
      modbusPortGroup.style.opacity = "1";
      modbusPortGroup.style.pointerEvents = "auto";
    } else {
      modbusPortInput.disabled = true;
      modbusPortInput.required = false;
      modbusPortGroup.style.opacity = "0.5";
      modbusPortGroup.style.pointerEvents = "none";
    }
  }

  // ã‚·ãƒªãƒ¼ã‚ºé¸æŠã®å‹•çš„æ›´æ–°
  document.getElementById("manufacturer").addEventListener("change", function() {
    const selected = this.value;
    
    // Modbusãƒãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateModbusPortState();
    
    // ã‚·ãƒªãƒ¼ã‚ºãƒªã‚¹ãƒˆã‚’æ›´æ–°
    fetch(`/api/series?manufacturer=${selected}`)
      .then(res => res.json())
      .then(data => {
        const seriesSelect = document.getElementById("series");
        seriesSelect.innerHTML = "";
        data.forEach((s, idx) => {
          const option = document.createElement("option");
          option.value = s;
          option.textContent = s;
          if (idx === 0) option.selected = true;
          seriesSelect.appendChild(option);
        });
      });
  });

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Modbusãƒãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    updateModbusPortState();
  });

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const inputs = this.closest('.plc-config-item').querySelectorAll('input[type="text"], input[type="number"]');
      inputs.forEach(input => {
        if (input.type !== 'checkbox') {
          input.disabled = !this.checked;
          input.style.opacity = this.checked ? '1' : '0.5';
        }
      });
    });
    
    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    checkbox.dispatchEvent(new Event('change'));
  });

  // åˆæœŸåŒ–å‡¦ç†
  async function initializeMonitoring() {
    // è¨­å‚™æƒ…å ±ã‚’æœ€åˆã«æ›´æ–°ï¼ˆDBå„ªå…ˆï¼‰
    await updateEquipmentInfo();
    // PLCãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
    updateMonitoringData();
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€å®šé–“éš”ã§æ›´æ–°
  setInterval(updateMonitoringData, 3000);
  
  // è¨­å‚™æƒ…å ±ã¯å°‘ã—é•·ã„é–“éš”ã§æ›´æ–°ï¼ˆè¨­å®šå¤‰æ›´ã‚’åæ˜ ï¼‰
  setInterval(updateEquipmentInfo, 10000);
  
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
  initializeMonitoring();
</script>
{% endblock %}
