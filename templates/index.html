{% extends "base.html" %}
{% block title %}設備設定{% endblock %}

{% block content %}
<div class="container">
  <h1>PLC設定パネル</h1>
  <form method="POST">
    <label for="manufacturer">PLCメーカー</label>
    <select id="manufacturer" name="manufacturer" onchange="setDefaultPort()">
      {% for m in manufacturers %}
        <option value="{{ m }}" {% if current.manufacturer == m %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>

    <label for="ip">IPアドレス</label>
    <input type="text" id="ip" name="ip" placeholder="例：192.168.0.10" value="{{ current.ip or '' }}" required>

    <label for="port">ポート番号</label>
    <input type="number" id="port" name="port" value="{{ current.port or '' }}" required>

    <label for="interval">データ取得周期（秒）</label>
    <input type="number" id="interval" name="interval" value="{{ current.interval or 5 }}" required>

    <button type="submit">設定を保存</button>
  </form>

  <hr>

  <h2>接続テスト</h2>
  <button onclick="testConnection()">接続を確認</button>
  <p id="test-result">未実行</p>

  <!-- 戻るボタン -->
  <a href="/" style="display:inline-block; margin-top: 20px;">← 設備一覧に戻る</a>
</div>

<script>
  const defaultPorts = {
    "Mitsubishi": 5000,
    "Omron": 9600,
    "Keyence": 8501
  };

  function setDefaultPort() {
    const manu = document.getElementById("manufacturer").value;
    document.getElementById("port").value = defaultPorts[manu];
  }

  async function testConnection() {
    const ip = document.getElementById("ip").value;
    const port = parseInt(document.getElementById("port").value);
    const manufacturer = document.getElementById("manufacturer").value;

    const response = await fetch("/test-connection", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ ip, port, manufacturer })
    });

    const result = await response.json();
    document.getElementById("test-result").textContent = result.success ? "接続成功！" : "接続失敗...";
  }
</script>
{% endblock %}
