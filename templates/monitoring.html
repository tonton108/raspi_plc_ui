{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="monitor-card">
    <h2>ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</h2>
    <p><strong>è¨­å‚™ID:</strong> {{ equipment["equipment_id"] }}</p>
    <p><strong>ãƒ¡ãƒ¼ã‚«ãƒ¼:</strong> {{ equipment.manufacturer or 'N/A' }}</p>
    <p><strong>æ¥ç¶šå…ˆ:</strong> {{ equipment.ip }}:{{ equipment.port }}</p>
    <p><strong>ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ :</strong> <span id="cycle-time">N/A</span></p>
    <p><strong>çŠ¶æ…‹:</strong> <span id="equipment-status" class="status-badge gray">æœªæ¥ç¶š</span></p>

    <div class="button-group">
      <button onclick="testConnection()" class="btn primary">ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
      <a href="{{ url_for('equipment_config') }}" class="btn settings">âš™ï¸ è¨­å®šå¤‰æ›´</a>
    </div>
  </div>
</div>

<script>
  let lastTimestamp = null;

  function updateMonitoringData() {
    fetch('/api/logs')
      .then(res => {
        if (!res.ok) {
          throw new Error("ãƒ­ã‚°å–å¾—å¤±æ•—");
        }
        return res.json();
      })
      .then(data => {
        const now = new Date();
        const ts = new Date(data.timestamp);

        const cycleTime = lastTimestamp ? now - lastTimestamp : null;
        lastTimestamp = now;

        if (cycleTime !== null) {
          document.getElementById("cycle-time").textContent = `${cycleTime} ms`;

          const statusEl = document.getElementById("equipment-status");
          if (cycleTime > 3000) {
            statusEl.textContent = "åœæ­¢";
            statusEl.className = "status-badge red";
          } else {
            statusEl.textContent = "ç¨¼åƒä¸­";
            statusEl.className = "status-badge green";
          }
        }
      })
      .catch(err => {
        console.error("ãƒ­ã‚°å–å¾—å¤±æ•—", err);
        document.getElementById("cycle-time").textContent = "N/A";
        const statusEl = document.getElementById("equipment-status");
        statusEl.textContent = "æœªæ¥ç¶š";
        statusEl.className = "status-badge gray";
      });
  }

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => {
      toast.classList.remove("show");
    }, 3000);
  }

  async function testConnection() {
    showToast("æ¥ç¶šä¸­â€¦");

    try {
      const response = await fetch("/test-connection", { method: "POST" });
      const result = await response.json();

      if (result.success) {
        showToast("æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸã€‚");
      } else {
        showToast("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }

      setTimeout(() => location.reload(), 1500);

    } catch (error) {
      showToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€å®šé–“éš”ã§æ›´æ–°
  setInterval(updateMonitoringData, 3000);
  updateMonitoringData();
</script>
{% endblock %}
