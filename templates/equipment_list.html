{% extends "base.html" %}

{% block title %}è¨­å‚™ä¸€è¦§{% endblock %}

{% block content %}
<h1>è¨­å‚™ä¸€è¦§</h1>

<!-- æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ -->
<button onclick="openModal()">â• æ–°è¦è¨­å‚™ã‚’è¿½åŠ </button>

<div class="card-grid">
  {% for eq in equipment_data %}
    <div class="card {% if eq.abnormal %}abnormal{% endif %}">
      <div class="card-title">ID: {{ eq.id }}</div>
      <div class="latest-value">æœ€æ–°ãƒ­ã‚°: {{ eq.latest }}</div>
      <a href="/equipment_config/{{ eq.id }}">è¨­å®šç”»é¢ã¸</a>
      <button onclick="testConnection('{{ eq.id }}')">ğŸ§ª æ¥ç¶šç¢ºèª</button>
    </div>
  {% endfor %}
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">Ã—</span>
    <h3>è¨­å‚™ã‚’è¿½åŠ </h3>
    <form id="addForm" method="post" action="/equipment_add">
      <input type="text" name="equipment_id" placeholder="è¨­å‚™ID" required />
      <button type="submit">è¿½åŠ </button>
    </form>
  </div>
</div>

<script>
  function openModal() {
    document.getElementById('addModal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('addModal').style.display = 'none';
  }

  async function testConnection(id) {
    const res = await fetch('/test-connection', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id })
    });
    const result = await res.json();
    alert(`${id} ã®æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ: ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
  }

  // å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  window.onclick = function(e) {
    if (e.target === document.getElementById('addModal')) {
      closeModal();
    }
  }
</script>
{% endblock %}
