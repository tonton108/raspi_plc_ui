{% extends "base.html" %}
{% block title %}åˆæœŸè¨­å®š{% endblock %}

{% block content %}
<div class="container">
  <div class="monitor-card">
    <h2>ğŸš€ åˆæœŸè¨­å®š</h2>
    
    {% if error %}
    <div style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 12px; margin-bottom: 16px; color: #c62828;">
      <strong>âŒ ã‚¨ãƒ©ãƒ¼:</strong> {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div style="background-color: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 12px; margin-bottom: 16px; color: #2e7d32;">
      <strong>âœ… æˆåŠŸ:</strong> {{ success }}
    </div>
    {% endif %}

    <form method="post" class="form-grid">
      <!-- åŸºæœ¬è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="form-section">
        <h3 style="color: var(--primary); margin-bottom: 16px;">ğŸ­ åŸºæœ¬è¨­å®š</h3>
        
        <div class="basic-config-grid">
          <div class="form-group">
            <label><strong>è¨­å‚™ID:</strong></label>
            <input type="text" name="equipment_id" value="{{ equipment.equipment_id or '' }}" required>
          </div>

          <div class="form-group">
            <label><strong>PLCãƒ¡ãƒ¼ã‚«ãƒ¼:</strong></label>
            <select name="manufacturer" id="manufacturer" required>
              {% for m in manufacturers %}
                <option value="{{ m }}" {% if equipment.manufacturer == m %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label><strong>ã‚·ãƒªãƒ¼ã‚º:</strong></label>
            <select name="series" id="series" required>
              {% for s in series_list.get(equipment.manufacturer or '', []) %}
                <option value="{{ s }}" {% if equipment.series == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label><strong>ğŸ¯ PLC IPã‚¢ãƒ‰ãƒ¬ã‚¹:</strong></label>
            <input type="text" name="plc_ip" value="{{ equipment.plc_ip or '192.168.1.100' }}" 
                   placeholder="ä¾‹: 192.168.1.100" required>
          </div>

          <div class="form-group">
            <label><strong>PLCãƒãƒ¼ãƒˆ:</strong></label>
            <input type="number" name="plc_port" value="{{ equipment.plc_port or 5000 }}" required>
          </div>

          <div class="form-group">
            <label><strong>ğŸŒ ä¸­å¤®ã‚µãƒ¼ãƒãƒ¼IP:</strong></label>
            <input type="text" name="central_server_ip" value="{{ equipment.central_server_ip or '192.168.1.10' }}" 
                   placeholder="ä¾‹: 192.168.1.10" required>
          </div>

          <div class="form-group">
            <label><strong>ä¸­å¤®ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆ:</strong></label>
            <input type="number" name="central_server_port" value="{{ equipment.central_server_port or 5000 }}" required>
          </div>

          <div class="form-group">
            <label><strong>å–å¾—é–“éš” (ms):</strong></label>
            <input type="number" name="interval" value="{{ equipment.interval or 1000 }}" required>
          </div>

          <div class="form-group">
            <label><strong>ğŸ”Œ Modbusãƒãƒ¼ãƒˆ:</strong> <small style="color: #666;">â€»ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹PLCä½¿ç”¨æ™‚ã®ã¿å¿…è¦</small></label>
            <input type="number" name="modbus_port" value="{{ equipment.modbus_port or 502 }}" 
                   placeholder="ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹ç”¨ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 502)">
          </div>
        </div>
      </div>

      <!-- PLCã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="form-section">
        <h3 style="color: var(--primary); margin: 20px 0 16px 0;">ğŸ“ PLCãƒ‡ãƒ¼ã‚¿é …ç›®è¨­å®š</h3>
        
        <div class="data-config-section">
          <div class="plc-config-grid">
            
            <!-- ç”Ÿç”£æ•°é‡ -->
            <div class="plc-config-item">
              <label class="plc-config-toggle">
                <input type="checkbox" name="production_count_enabled" value="true" 
                       {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.enabled %}checked{% endif %}>
                <span class="plc-icon">ğŸ“Š</span>
                <strong>ç”Ÿç”£æ•°é‡</strong>
              </label>
              <div class="plc-config-inputs">
                <input type="text" name="production_count_address" 
                       value="{{ equipment.data_points.production_count.address if equipment.data_points and equipment.data_points.production_count else 'D150' }}" 
                       placeholder="D150">
                <select name="production_count_data_type" class="data-type-select">
                  <option value="word" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'word' %}selected{% elif not equipment.data_points or not equipment.data_points.production_count %}selected{% endif %}>Word (16bit)</option>
                  <option value="dword" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                  <option value="float32" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'float32' %}selected{% endif %}>Float32</option>
                  <option value="bit" {% if equipment.data_points and equipment.data_points.production_count and equipment.data_points.production_count.data_type == 'bit' %}selected{% endif %}>Bit</option>
                </select>
                <input type="number" name="production_count_scale" 
                       value="{{ equipment.data_points.production_count.scale if equipment.data_points and equipment.data_points.production_count else 1 }}" 
                       placeholder="å€ç‡" min="1">
              </div>
            </div>

            <!-- é›»æµ -->
            <div class="plc-config-item">
              <label class="plc-config-toggle">
                <input type="checkbox" name="current_enabled" value="true" 
                       {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.enabled %}checked{% else %}checked{% endif %}>
                <span class="plc-icon">âš¡</span>
                <strong>é›»æµ</strong>
              </label>
              <div class="plc-config-inputs">
                <input type="text" name="current_address" 
                       value="{{ equipment.data_points.current.address if equipment.data_points and equipment.data_points.current else 'D100' }}" 
                       placeholder="D100">
                <select name="current_data_type" class="data-type-select">
                  <option value="word" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'word' %}selected{% endif %}>Word (16bit)</option>
                  <option value="dword" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                  <option value="float32" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'float32' %}selected{% endif %}>Float32</option>
                  <option value="bit" {% if equipment.data_points and equipment.data_points.current and equipment.data_points.current.data_type == 'bit' %}selected{% endif %}>Bit</option>
                </select>
                <input type="number" name="current_scale" 
                       value="{{ equipment.data_points.current.scale if equipment.data_points and equipment.data_points.current else 10 }}" 
                       placeholder="å€ç‡" min="1">
              </div>
            </div>

            <!-- æ¸©åº¦ -->
            <div class="plc-config-item">
              <label class="plc-config-toggle">
                <input type="checkbox" name="temperature_enabled" value="true" 
                       {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.enabled %}checked{% else %}checked{% endif %}>
                <span class="plc-icon">ğŸŒ¡ï¸</span>
                <strong>æ¸©åº¦</strong>
              </label>
              <div class="plc-config-inputs">
                <input type="text" name="temperature_address" 
                       value="{{ equipment.data_points.temperature.address if equipment.data_points and equipment.data_points.temperature else 'D101' }}" 
                       placeholder="D101">
                <select name="temperature_data_type" class="data-type-select">
                  <option value="word" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'word' %}selected{% endif %}>Word (16bit)</option>
                  <option value="dword" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                  <option value="float32" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'float32' %}selected{% elif not equipment.data_points or not equipment.data_points.temperature %}selected{% endif %}>Float32</option>
                  <option value="bit" {% if equipment.data_points and equipment.data_points.temperature and equipment.data_points.temperature.data_type == 'bit' %}selected{% endif %}>Bit</option>
                </select>
                <input type="number" name="temperature_scale" 
                       value="{{ equipment.data_points.temperature.scale if equipment.data_points and equipment.data_points.temperature else 1 }}" 
                       placeholder="å€ç‡" min="1">
              </div>
            </div>

            <!-- åœ§åŠ› -->
            <div class="plc-config-item">
              <label class="plc-config-toggle">
                <input type="checkbox" name="pressure_enabled" value="true" 
                       {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.enabled %}checked{% else %}checked{% endif %}>
                <span class="plc-icon">ğŸ”§</span>
                <strong>åœ§åŠ›</strong>
              </label>
              <div class="plc-config-inputs">
                <input type="text" name="pressure_address" 
                       value="{{ equipment.data_points.pressure.address if equipment.data_points and equipment.data_points.pressure else 'D102' }}" 
                       placeholder="D102">
                <select name="pressure_data_type" class="data-type-select">
                  <option value="word" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'word' %}selected{% elif not equipment.data_points or not equipment.data_points.pressure %}selected{% endif %}>Word (16bit)</option>
                  <option value="dword" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                  <option value="float32" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'float32' %}selected{% endif %}>Float32</option>
                  <option value="bit" {% if equipment.data_points and equipment.data_points.pressure and equipment.data_points.pressure.data_type == 'bit' %}selected{% endif %}>Bit</option>
                </select>
                <input type="number" name="pressure_scale" 
                       value="{{ equipment.data_points.pressure.scale if equipment.data_points and equipment.data_points.pressure else 100 }}" 
                       placeholder="å€ç‡" min="1">
              </div>
            </div>

            <!-- ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ  -->
            <div class="plc-config-item">
              <label class="plc-config-toggle">
                <input type="checkbox" name="cycle_time_enabled" value="true" 
                       {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.enabled %}checked{% else %}checked{% endif %}>
                <span class="plc-icon">â±ï¸</span>
                <strong>ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ </strong>
              </label>
              <div class="plc-config-inputs">
                <input type="text" name="cycle_time_address" 
                       value="{{ equipment.data_points.cycle_time.address if equipment.data_points and equipment.data_points.cycle_time else 'D200' }}" 
                       placeholder="D200">
                <select name="cycle_time_data_type" class="data-type-select">
                  <option value="word" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'word' %}selected{% endif %}>Word (16bit)</option>
                  <option value="dword" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'dword' %}selected{% elif not equipment.data_points or not equipment.data_points.cycle_time %}selected{% endif %}>DWord (32bit)</option>
                  <option value="float32" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'float32' %}selected{% endif %}>Float32</option>
                  <option value="bit" {% if equipment.data_points and equipment.data_points.cycle_time and equipment.data_points.cycle_time.data_type == 'bit' %}selected{% endif %}>Bit</option>
                </select>
                <input type="number" name="cycle_time_scale" 
                       value="{{ equipment.data_points.cycle_time.scale if equipment.data_points and equipment.data_points.cycle_time else 1 }}" 
                       placeholder="å€ç‡" min="1">
              </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ -->
            <div class="plc-config-item">
              <label class="plc-config-toggle">
                <input type="checkbox" name="error_code_enabled" value="true" 
                       {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.enabled %}checked{% else %}checked{% endif %}>
                <span class="plc-icon">âš ï¸</span>
                <strong>ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰</strong>
              </label>
              <div class="plc-config-inputs">
                <input type="text" name="error_code_address" 
                       value="{{ equipment.data_points.error_code.address if equipment.data_points and equipment.data_points.error_code else 'D300' }}" 
                       placeholder="D300">
                <select name="error_code_data_type" class="data-type-select">
                  <option value="word" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'word' %}selected{% elif not equipment.data_points or not equipment.data_points.error_code %}selected{% endif %}>Word (16bit)</option>
                  <option value="dword" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'dword' %}selected{% endif %}>DWord (32bit)</option>
                  <option value="float32" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'float32' %}selected{% endif %}>Float32</option>
                  <option value="bit" {% if equipment.data_points and equipment.data_points.error_code and equipment.data_points.error_code.data_type == 'bit' %}selected{% endif %}>Bit</option>
                </select>
                <input type="number" name="error_code_scale" 
                       value="{{ equipment.data_points.error_code.scale if equipment.data_points and equipment.data_points.error_code else 1 }}" 
                       placeholder="å€ç‡" min="1">
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="button-group">
        <button type="submit" class="btn primary">ğŸ’¾ è¨­å®šå®Œäº†</button>
      </div>
    </form>
  </div>
</div>

<script type="application/json" id="series-data">{{ series_list | tojson | safe }}</script>
<script type="application/json" id="current-series">"{{ equipment.series or '' }}"</script>

<script>
  // PLCãƒ¡ãƒ¼ã‚«ãƒ¼å¤‰æ›´æ™‚ã®ã‚·ãƒªãƒ¼ã‚ºæ›´æ–°
  document.addEventListener('DOMContentLoaded', function() {
    updateModbusPortState();
  });

  function updateModbusPortState() {
    const manufacturerSelect = document.getElementById('manufacturer');
    const seriesSelect = document.getElementById('series');
    const series_data = JSON.parse(document.getElementById('series-data').textContent);
    const currentSeries = JSON.parse(document.getElementById('current-series').textContent);

    function updateSeries() {
      const manufacturer = manufacturerSelect.value;
      seriesSelect.innerHTML = '';

      if (series_data[manufacturer]) {
        series_data[manufacturer].forEach(function(series) {
          const option = document.createElement('option');
          option.value = series;
          option.textContent = series;
          if (series === currentSeries) {
            option.selected = true;
          }
          seriesSelect.appendChild(option);
        });
      }
    }

    manufacturerSelect.addEventListener('change', updateSeries);
    updateSeries();
  }

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é€£å‹•ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.plc-config-toggle input[type="checkbox"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const configItem = this.closest('.plc-config-item');
      const inputs = configItem.querySelectorAll('.plc-config-inputs input, .plc-config-inputs select');
      
      inputs.forEach(function(input) {
        input.disabled = !checkbox.checked;
        if (!checkbox.checked) {
          input.style.opacity = '0.5';
        } else {
          input.style.opacity = '1';
        }
      });
    });
    
    // åˆæœŸåŒ–æ™‚ã«å®Ÿè¡Œ
    checkbox.dispatchEvent(new Event('change'));
  });
</script>
{% endblock %}
